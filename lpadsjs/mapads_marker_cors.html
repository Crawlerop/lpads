
    <!DOCTYPE html>
    <html>
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
            <title>MapAds demo</title>
            <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" crossorigin=""/>
            <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js" crossorigin=""></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
            <script src="./mapads.js" crossorigin=""></script>
            <style>
                body {
                    padding: 0;
                    margin: 0;
                }
                html, body, #mapid {
                    height: 100%;
                    width: 100%;
                }
                textarea.righttext {
                    position:absolute;
                    right:1px;
                    bottom:15px;
                    resize:none;
                }
                button.rightbutton {
                    position:absolute;
                    right:1px;
                    bottom:15px;
                    resize:none;
                }
            </style>
            
        </head>
        <body>
            <div id="mapid"></div>
            <script>
                var searching = false;
                var xhr = new XMLHttpRequest()
                var xhr2 = new XMLHttpRequest()
                var start = [40.7127837, -74.00594130000002]
                var addLayer = false;
                var searchAPIURL = "https://api.mapbox.com/geocoding/v5/mapbox.places/(query).json?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw&limit=1";

                try {
                    up = new URLSearchParams(window.location.search)
                    if (up.get('lat') != null && up.get('lng') != null)
                    var start = [parseFloat(up.get('lat')), parseFloat(up.get('lng'))]
                    if (up.get('localads') == "true") {
                        addLayer = true
                    }
                } catch (e) {

                }

                var going = false;

                var data = L.layerGroup()

                mapboxattr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' + '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>'

                gmapsattr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' + '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="https://maps.google.com/">Google Maps</a>'

                esriattr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' + '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="https://www.esri.com/">ESRI</a>'
                
                osmattr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'

                normal = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 21,
                    attribution: mapboxattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 512,
                    zoomOffset: -1
                })

                mdefault = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 21,
                    attribution: mapboxattr,
                    id: 'mapbox/streets-v11',
                    tileSize: 512,
                    zoomOffset: -1
                })

                mgray = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 21,
                    attribution: mapboxattr,
                    id: 'mapbox/light-v9',
                    tileSize: 512,
                    zoomOffset: -1
                })

                esrinormal = L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 21,
                    attribution: esriattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                esriterrain = L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 21,
                    attribution: esriattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 21,
                    attribution: osmattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                satellite = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 21,
                    attribution: mapboxattr,
                    id: 'user12435235124125235824592457/ckanekpxi1o3y1ipkm8tl6v3i',
                    tileSize: 512,
                    zoomOffset: -1
                })

                satellitenotext = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 21,
                    attribution: mapboxattr,
                    id: 'user12435235124125235824592457/ckb7ik2nf4rel1ip61enm2h23',
                    tileSize: 512,
                    zoomOffset: -1
                })

                gmapsnormal = L.tileLayer('https://www.google.com/maps/vt/pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m1!1i0!3m2!2sen-US!5i1106!5m1!5f4.0!23i1358902', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                gmapsvue = L.tileLayer('https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i520236120!3m17!2sen-US!3sUS!5e18!12m4!1e68!2m2!1sset!2sRoadmap!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy50OjF8cy5lOmwudC5mfHAuYzojZmY0NDQ0NDQscy50OjV8cC5jOiNmZmYyZjJmMixzLnQ6MnxwLnY6b2ZmLHMudDozfHAuczotMTAwfHAubDo0NSxzLnQ6NDl8cC52OnNpbXBsaWZpZWQscy50OjUwfHMuZTpsLml8cC52Om9mZixzLnQ6NHxwLnY6b2ZmLHMudDo2fHAuYzojZmYyNjJlNDV8cC52Om9uLHMudDo2fHMuZTpsfHAudjpvZmY!4e0!5m1!5f4.0', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                gmapsfb = L.tileLayer('https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i520236108!3m17!2sen-US!3sUS!5e18!12m4!1e68!2m2!1sset!2sRoadmap!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy5lOmwuaXxwLnY6b2ZmLHMudDoxfHAudjpvbixzLnQ6NXxwLmM6I2ZmZThlOWU5LHMudDoyfHMuZTpnfHAuYzojZmZlOGU5ZTkscy50OjQwfHAuYzojZmZiYWQyOTQscy50OjQwfHMuZTpsfHAudjpvZmYscy50OjQ5fHMuZTpnLmZ8cC5jOiNmZmZmZmZmZixzLnQ6NDl8cy5lOmcuc3xwLnY6b2ZmLHMudDo1MHxzLmU6Zy5mfHAuYzojZmZmZmZmZmYscy50OjUwfHMuZTpnLnN8cC52Om9mZixzLnQ6NTF8cy5lOmcuZnxwLmM6I2ZmZmJmYmZiLHMudDo0fHAudjpvZmYscy50OjZ8cy5lOmd8cC5jOiNmZjQxYWVjOSxzLnQ6NnxzLmU6bC50LmZ8cC5jOiNmZjA2NTk3MSxzLnQ6NnxzLmU6bC50LnN8cC52OnNpbXBsaWZpZWQ!4e0!5m1!5f4.0', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                gmapsgray = L.tileLayer('https://maps.googleapis.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i520233372!3m17!2sen-US!3sUS!5e18!12m4!1e68!2m2!1sset!2sRoadmap!12m3!1e37!2m1!1ssmartmaps!12m4!1e26!2m2!1sstyles!2zcy50OjZ8cy5lOmd8cC5jOiNmZmU5ZTllOXxwLmw6MTcscy50OjV8cy5lOmd8cC5jOiNmZmY1ZjVmNXxwLmw6MjAscy50OjQ5fHMuZTpnLmZ8cC5jOiNmZmZmZmZmZnxwLmw6MTcscy50OjQ5fHMuZTpnLnN8cC5jOiNmZmZmZmZmZnxwLmw6Mjl8cC53OjAuMixzLnQ6NTB8cy5lOmd8cC5jOiNmZmZmZmZmZnxwLmw6MTgscy50OjUxfHMuZTpnfHAuYzojZmZmZmZmZmZ8cC5sOjE2LHMudDoyfHMuZTpnfHAuYzojZmZmNWY1ZjV8cC5sOjIxLHMudDo0MHxzLmU6Z3xwLmM6I2ZmZGVkZWRlfHAubDoyMSxzLmU6bC50LnN8cC52Om9ufHAuYzojZmZmZmZmZmZ8cC5sOjE2LHMuZTpsLnQuZnxwLnM6MzZ8cC5jOiNmZjMzMzMzM3xwLmw6NDAscy5lOmwuaXxwLnY6b2ZmLHMudDo0fHMuZTpnfHAuYzojZmZmMmYyZjJ8cC5sOjE5LHMudDoxfHMuZTpnLmZ8cC5jOiNmZmZlZmVmZXxwLmw6MjAscy50OjF8cy5lOmcuc3xwLmM6I2ZmZmVmZWZlfHAubDoxN3xwLnc6MS4y!4e0!5m1!5f4.0', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                gmapsbold = L.tileLayer('https://www.google.com/maps/vt?pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m2!2sm!3i504221335!3m7!2sen-US!5i1105!12m4!1i68!2m2!1sset!2sTerrain!5m1!5f4.0!23i1358902', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                esrisatellite = L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 21,
                    attribution: esriattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })                    

                esrisatellitealt = L.tileLayer('https://clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 21,
                    attribution: esriattr,
                    id: 'user12435235124125235824592457/ckao1rqf85kh01imwyf5b0pvc',
                    tileSize: 256,
                    zoomOffset: 0
                })

                gmapssatellite = L.tileLayer('https://mt{s}.googleapis.com/vt?lyrs=y&hl=en-US&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckanekpxi1o3y1ipkm8tl6v3i',
                    tileSize: 256,
                    zoomOffset: 0,
                    subdomains: ["0", "1", "2", "3"]
                })

                gmapssatellitenotext = L.tileLayer('https://mt{s}.googleapis.com/vt?lyrs=s&hl=en-US&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    attribution: gmapsattr,
                    id: 'user12435235124125235824592457/ckanekpxi1o3y1ipkm8tl6v3i',
                    tileSize: 256,
                    zoomOffset: 0,
                    subdomains: ["0", "1", "2", "3"]
                })

                blank = L.tileLayer('http://nope', {
                    maxZoom: 21,
                    attribution: "",
                    tileSize: 256,
                    zoomOffset: 0,
                })

                var mymap = L.map('mapid', {
                    center: start,
                    zoom: 14,
                    layers: [normal]
                })

                L.easyButton('fa-search', function(){
                    document.location = "search.html"
                }).addTo(mymap)

                if (addLayer == true) {
                    mymap.addLayer(data)
                }

                var layernames = {
                    "Mapbox Normal": normal,
                    "Mapbox Streets": mdefault,
                    "Mapbox Grayscale": mgray,
                    "Google Maps Normal": gmapsnormal,
                    "Google Maps Normal (Better)": gmapsfb,
                    "Google Maps Bold": gmapsbold,
                    "Google Maps Vue": gmapsvue,
                    "Google Maps Grayscale": gmapsgray,
                    "OSM": osm,
                    "ESRI Normal": esrinormal,
                    "ESRI Terrain": esriterrain,
                    "Mapbox Satellite": satellite,
                    "Mapbox Satellite (no label)": satellitenotext,
                    "Google Maps Satellite": gmapssatellite,
                    "Google Maps Satellite (no label)": gmapssatellitenotext,
                    "ESRI Satellite": esrisatellite,
                    "ESRI Satellite (alt)": esrisatellitealt,
                    "Empty Tile": blank,
                }
                
            
                layers = L.control.layers(layernames, {"Local Ads": data})
                layers.addTo(mymap)	

                function loadPins(adData) {
                    adData.forEach(function(ad) {
                        m = L.marker(ad.adLocation.split(", "), {title: ad.adName})
                        if (ad.adPinImage != null) {
                            m = L.marker(ad.adLocation.split(", "), {
                                title: ad.adName,
                                icon: L.icon({
                                    iconUrl: ad.adPinImage,
                                    iconSize: [32,32]
                                })
                            })

                        }
                        adTextData = "<h1>"+ad.adName+"</h1>"
                        lp = ad.adLocation.split(", ")
                        tg = searchAPIURL.replace("(query)", lp[1] + "," + lp[0])
                        if (ad.promoData == null) {
                            adTextData += "In: <b>(LocationName)</b><br>"
                            adTextData += "Why: <b>"+ad.adWhy+"</b>"
                            adTextData += "<br><br><a href=\""+ad.adLink+"\">"+ad.adSite+"</a>"
                        } else {
                            adTextData = "<h1>"+ad.promoData.adPromo.promoTitle+"</h1>"
                            adTextData += "<h2>"+ad.adName+"</h2>"
                            adTextData += "In: <b>(LocationName)</b><br>"
                            adTextData += "<h3>"+ad.promoData.adPromo.promoDesc+"</h3>"
                            adTextData += "Why: <b>"+ad.adWhy+"</b>"
                            adTextData += "<br><br><a href=\""+ad.adLink+"\">"+ad.promoData.adPromo.promoButton+"</a>"
                        }
                                    
                        pins.push(m)
                        xhr2.open("GET", tg, false)
                        xhr2.send()

                        adTextData = adTextData.replace("(LocationName)", JSON.parse(xhr2.responseText).features[0].place_name)
                        m.bindPopup(adTextData)
                        m.addTo(data)
                        
                    })
                }

                var adData = null;

                var pins = [];

                adMarker = new L.marker(start, {
                    title: "Drag or click me to find location ads nearby!", 
                    draggable: true, 
                    icon: L.icon({
                        iconUrl: "https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png",
                        iconSize: [48,48]
                    })
                })
                adMarker.addTo(data)
                adMarker.on("dragstart", function() {
                    if (going == true) {
                        xhr.abort()
                        going = false
                        searching = false
                    } 
                    pins.forEach(function(k){
                        k.remove()
                    }); 
                    pins = []
                })

                adMarker.on("dragend", function(ev) {
                    mk = ev.target
                    mkpos = mk.getLatLng()
                    mk.setLatLng(new L.LatLng(mkpos.lat, mkpos.lng),{draggable:'true'})    
                    mymap.panTo(new L.LatLng(mkpos.lat, mkpos.lng))
                    xhr.open("GET", "https://www.google.com/maps/preview/lp?authuser=0&hl=en&gl=us&pb=!1m3!1s0!7e81!15i60107!2m9!1m3!1d1!2d"+mkpos.lng+"!3d"+mkpos.lat+"!2m0!3m2!1i4096!2i2048!4f14!5m2!3b0!5e11")
                    xhr.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            going = false
                            out = xhr.responseText.replace(")]}'\n", "")
                            //console.log(out)
                            try {
                                adProto = JSON.parse(out)
                            } catch (e) {
                                return
                            }
                            adResp = parseAds(adProto)
                            if (adResp.noAds == true) {
                                console.warn("No ads found on "+mkpos.lat+", "+mkpos.lng+"!")
                            } else {
                                adData = adResp.mapAds
                                loadPins(adData)
                            }
                        }
                    }
                    going = true
                    xhr.send()
                })

                adMarker.on('click', function(){
                    if (going == true) {
                        xhr.abort()
                        going = false
                        searching = false
                    } 
                    pins.forEach(function(k){
                        k.remove()
                    }); 
                    pins = []
                    pos = adMarker.getLatLng()
                    xhr.open("GET", "https://www.google.com/maps/preview/lp?authuser=0&hl=en&gl=us&pb=!1m3!1s0!7e81!15i60107!2m9!1m3!1d1!2d"+pos.lng+"!3d"+pos.lat+"!2m0!3m2!1i4096!2i2048!4f14!5m2!3b0!5e11")
                    xhr.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            going = false
                            out = xhr.responseText.replace(")]}'\n", "")
                            //console.log(out)
                            try {
                                adProto = JSON.parse(out)
                            } catch (e) {
                                return
                            }
                            adResp = parseAds(adProto)
                            if (adResp.noAds == true) {
                                console.warn("No ads found on "+pos.lat+", "+pos.lng+"!")
                            } else {
                                adData = adResp.mapAds
                                loadPins(adData)
                            }
                        }
                    }
                    going = true
                    xhr.send()
                })

                xhr.open("GET", "https://www.google.com/maps/preview/lp?authuser=0&hl=en&gl=us&pb=!1m3!1s0!7e81!15i60107!2m9!1m3!1d1!2d"+start[1]+"!3d"+start[0]+"!2m0!3m2!1i4096!2i2048!4f14!5m2!3b0!5e11")
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        going = false
                        out = xhr.responseText.replace(")]}'\n", "")
                        //console.log(out)
                        try {
                            adProto = JSON.parse(out)
                        } catch (e) {
                             return
                        }
                        adResp = parseAds(adProto)
                        if (adResp.noAds == true) {
                            console.warn("No ads found on "+start[1]+", "+start[0]+"!")
                        } else {
                            adData = adResp.mapAds
                            loadPins(adData)
                        }
                    }
                }
                going = true
                xhr.send()

                function dosearch() {
                    if (searching == true && going == true) {
                        xhr.abort()
                        going = false
                        searching = false
                        return
                    }
                    if (going == true) {
                        xhr.abort()
                        going = false
                        searching = false
                    } 
                    searching = true
                    pins.forEach(function(k){
                        k.remove()
                    }); 
                    pins = []
                    pos = adMarker.getLatLng()
                    xhr.open("GET", "https://www.google.com/maps/preview/lp?authuser=0&hl=en&gl=us&pb=!1m3!1s0!7e81!15i60107!2m9!1m3!1d1!2d"+pos.lng+"!3d"+pos.lat+"!2m0!3m2!1i4096!2i2048!4f14!5m2!3b0!5e11")
                    xhr.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            going = false
                            out = xhr.responseText.replace(")]}'\n", "")
                            //console.log(out)
                            try {
                                adProto = JSON.parse(out)
                            } catch (e) {
                                return
                            }
                            adResp = parseAds(adProto)
                            if (adResp.noAds == true) {
                                console.warn("No ads found on "+pos.lat+", "+pos.lng+"!")
                                if (searching) {dosearch()}
                            } else {
                                searching = false
                                adData = adResp.mapAds
                                loadPins(adData)
                            }
                        }
                    }
                    going = true
                    xhr.send()
                }

                L.easyButton('fa-map-marker', dosearch).addTo(mymap)

                //console.log(addLayer)
            </script>
        </body>
    </html>
